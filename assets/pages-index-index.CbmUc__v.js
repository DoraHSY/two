import{c as t,a as e,s,b as a,d as i,p as n,e as o,h as l,f as c,g as r,u as h,i as d,w as u,j as g,o as f,k as v,l as C,n as p,m,t as w,q as y,r as x,v as I,F as R,x as k,y as b,z as _,A as F,B as M,I as P}from"./index-CnC2cWZh.js";const D="https://hhhh-192650-4-1382535781.sh.run.tcloudbase.com/api/transform";const T=((t,e)=>{const s=t.__vccOpts||t;for(const[a,i]of e)s[a]=i;return s})({data:()=>({inputImage:"",outputImage:"",outputImagePath:"",loading:!1,isDrawMode:!1,canvasContext:null,drawing:!1,isDragging:!1,currentRect:null,rects:[],selectedRectIndex:-1,dragOffset:{x:0,y:0},currentColor:"#000000",drawingHistory:[],showColorPicker:!1,fillMode:!0,customColor:"#000000",colorPalette:["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#008000","#800000","#008080","#000080","#808080","#C0C0C0","#FFB6C1","#FFD700","#ADFF2F","#FF4500","#2E8B57"],canvasWidth:400,canvasHeight:400,isInitialized:!1,canvasRect:null,showOutputTip:!1,longPressTimer:null,isLongPressing:!1}),mounted(){this.initCanvas(),this.bindKeyboardEvents()},beforeUnmount(){this.unbindKeyboardEvents(),this.clearLongPressTimer()},methods:{bindKeyboardEvents(){document.addEventListener("keydown",this.handleKeyDown)},unbindKeyboardEvents(){document.removeEventListener("keydown",this.handleKeyDown)},handleKeyDown(t){this.isDrawMode&&((t.ctrlKey||t.metaKey)&&"z"===t.key&&(t.preventDefault(),this.undo()),"Delete"===t.key&&-1!==this.selectedRectIndex&&(t.preventDefault(),this.deleteSelectedRect()))},async initCanvas(){this.isInitialized||(this.canvasContext=t("drawingCanvas",this),await this.getCanvasRect(),this.canvasContext.setFillStyle("#ffffff"),this.canvasContext.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.canvasContext.draw(!0),this.rects=[],this.isInitialized=!0,console.log("Canvas initialized successfully"))},async getCanvasRect(){return new Promise((t=>{e().in(this).select("#drawingCanvas").boundingClientRect((e=>{e&&(this.canvasWidth=e.width,this.canvasHeight=e.height,this.canvasRect=e,console.log("Canvas rect updated:",e)),t(e)})).exec()}))},async setMode(t){this.isDrawMode=t,t&&(this.inputImage="",await this.$nextTick(),await this.initCanvas(),this.clearCanvas())},clearInput(){this.isDrawMode?this.clearCanvas():this.inputImage="",s({title:"已清空输入",icon:"none",duration:1e3})},clearOutput(){this.outputImage="",this.outputImagePath="",s({title:"已清空结果",icon:"none",duration:1e3})},async getEventPosition(t){let e,s;if(await this.getCanvasRect(),t.type.includes("touch")){const a=t.touches[0];e=a.clientX,s=a.clientY}else e=t.clientX,s=t.clientY;const a=e-this.canvasRect.left,i=s-this.canvasRect.top;return{x:Math.max(0,Math.min(a,this.canvasWidth)),y:Math.max(0,Math.min(i,this.canvasHeight))}},async handleCanvasStart(t){t.preventDefault&&t.preventDefault();const e=await this.getEventPosition(t),s=this.findRectAtPosition(e.x,e.y);if(-1!==s)if(this.selectedRectIndex===s){this.isDragging=!0;const t=this.rects[s];this.dragOffset={x:e.x-t.x,y:e.y-t.y}}else this.selectedRectIndex=s,this.redrawCanvas();else this.drawing=!0,this.selectedRectIndex=-1,this.currentRect={x:e.x,y:e.y,width:0,height:0,color:this.currentColor,fillMode:this.fillMode},this.redrawCanvas()},async handleCanvasMove(t){if(!this.drawing&&!this.isDragging)return;t.preventDefault&&t.preventDefault();const e=await this.getEventPosition(t);if(this.drawing&&this.currentRect)this.currentRect.width=e.x-this.currentRect.x,this.currentRect.height=e.y-this.currentRect.y,this.redrawCanvasWithCurrentRect();else if(this.isDragging&&-1!==this.selectedRectIndex){const t=this.rects[this.selectedRectIndex];t.x=e.x-this.dragOffset.x,t.y=e.y-this.dragOffset.y,t.x=Math.max(0,Math.min(t.x,this.canvasWidth-t.width)),t.y=Math.max(0,Math.min(t.y,this.canvasHeight-t.height)),this.redrawCanvas()}},async handleCanvasEnd(t){t.preventDefault&&t.preventDefault(),this.drawing&&this.currentRect?(Math.abs(this.currentRect.width)>5&&Math.abs(this.currentRect.height)>5&&(this.currentRect.width<0&&(this.currentRect.x+=this.currentRect.width,this.currentRect.width=-this.currentRect.width),this.currentRect.height<0&&(this.currentRect.y+=this.currentRect.height,this.currentRect.height=-this.currentRect.height),this.saveCanvasState(),this.rects.push({...this.currentRect}),this.selectedRectIndex=this.rects.length-1),this.currentRect=null,this.drawing=!1,this.redrawCanvas()):this.isDragging&&(this.isDragging=!1,this.saveCanvasState())},handleDoubleClick(t){-1!==this.selectedRectIndex&&(console.log("双击矩形:",this.selectedRectIndex),this.deleteSelectedRect())},handleContextMenu(t){t.preventDefault()},deleteSelectedRect(){-1!==this.selectedRectIndex&&(this.saveCanvasState(),this.rects.splice(this.selectedRectIndex,1),this.selectedRectIndex=-1,this.redrawCanvas(),s({title:"已删除矩形",icon:"none",duration:1e3}))},findRectAtPosition(t,e){for(let s=this.rects.length-1;s>=0;s--){const a=this.rects[s];if(t>=a.x&&t<=a.x+a.width&&e>=a.y&&e<=a.y+a.height)return s}return-1},redrawCanvasWithCurrentRect(){this.canvasContext.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.canvasContext.setFillStyle("#ffffff"),this.canvasContext.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.rects.forEach(((t,e)=>{this.drawRect(t,e===this.selectedRectIndex)})),this.currentRect&&this.drawRect(this.currentRect,!1),this.canvasContext.draw(!0)},redrawCanvas(){this.canvasContext.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.canvasContext.setFillStyle("#ffffff"),this.canvasContext.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.rects.forEach(((t,e)=>{this.drawRect(t,e===this.selectedRectIndex)})),this.canvasContext.draw(!0)},drawRect(t,e=!1){t.fillMode?(this.canvasContext.setFillStyle(t.color),this.canvasContext.fillRect(t.x,t.y,t.width,t.height)):(this.canvasContext.setStrokeStyle(t.color),this.canvasContext.setLineWidth(2),this.canvasContext.strokeRect(t.x,t.y,t.width,t.height)),e&&(this.canvasContext.setStrokeStyle("#0066cc"),this.canvasContext.setLineWidth(2),this.canvasContext.setLineDash([5,5]),this.canvasContext.strokeRect(t.x-2,t.y-2,t.width+4,t.height+4),this.canvasContext.setLineDash([]))},toggleColorPicker(){this.showColorPicker=!this.showColorPicker},selectColor(t){this.currentColor=t,this.showColorPicker=!1,s({title:"已选择颜色",icon:"none",duration:1e3})},validateColor(){/^#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{3})$/.test(this.customColor)||console.log("颜色格式不正确")},confirmCustomColor(){this.validateColor(),this.currentColor=this.customColor,this.showColorPicker=!1,s({title:"已选择自定义颜色",icon:"none",duration:1e3})},toggleFillMode(){this.fillMode=!this.fillMode,s({title:this.fillMode?"已切换为填充模式":"已切换为描边模式",icon:"none",duration:1e3})},saveCanvasState(){this.drawingHistory.push({timestamp:Date.now(),rects:JSON.parse(JSON.stringify(this.rects)),selectedRectIndex:this.selectedRectIndex}),this.drawingHistory.length>10&&this.drawingHistory.shift()},undo(){if(this.drawingHistory.length>1){this.drawingHistory.pop();const t=this.drawingHistory[this.drawingHistory.length-1];t?(this.rects=t.rects,this.selectedRectIndex=t.selectedRectIndex):(this.rects=[],this.selectedRectIndex=-1),this.redrawCanvas(),s({title:"已撤销",icon:"none",duration:1e3})}else 1===this.drawingHistory.length&&(this.drawingHistory=[],this.rects=[],this.selectedRectIndex=-1,this.redrawCanvas(),s({title:"已撤销",icon:"none",duration:1e3}))},clearCanvas(){this.canvasContext.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.canvasContext.setFillStyle("#ffffff"),this.canvasContext.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.drawingHistory=[],this.rects=[],this.selectedRectIndex=-1,this.currentRect=null,this.canvasContext.draw(!0)},getCanvasImage(){return new Promise((t=>{a({canvasId:"drawingCanvas",success:e=>{t(e.tempFilePath)},fail:e=>{console.error("获取画布图片失败:",e),t(null)}},this)}))},handleOutputTouchStart(t){this.clearLongPressTimer(),this.isLongPressing=!0,this.longPressTimer=setTimeout((()=>{this.saveOutputImage(),this.isLongPressing=!1}),800)},handleOutputTouchEnd(t){this.clearLongPressTimer(),this.isLongPressing&&(this.isLongPressing=!1)},clearLongPressTimer(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)},handleOutputContextMenu(t){t.preventDefault(),this.outputImage&&(this.showOutputTip=!0)},async chooseImage(){try{const t=(await new Promise(((t,e)=>{i({count:1,success:t,fail:e})}))).tempFilePaths[0];console.log("File selected: ",t),this.inputImage=t}catch(t){console.error("选择图片失败:",t),s({title:"图片选择失败",icon:"none"})}},previewOutputImage(){this.outputImage?(this.outputImage.startsWith("data:"),n({urls:[this.outputImage],success:()=>{console.log("图片预览成功")},fail:t=>{console.error("图片预览失败:",t),s({title:"预览失败",icon:"none"})}})):this.showOutputTip=!0},saveOutputImage(){if(this.outputImage)if(o({title:"保存中..."}),this.outputImage.startsWith("data:")){const t=this.outputImage.split(",")[1],e=`${wx.env.USER_DATA_PATH}/output_${Date.now()}.jpg`;uni.getFileSystemManager().writeFile({filePath:e,data:t,encoding:"base64",success:()=>{this.saveImageToAlbum(e)},fail:t=>{console.error("写入文件失败:",t),l(),s({title:"保存失败",icon:"none"})}})}else this.saveImageToAlbum(this.outputImage);else s({title:"没有可保存的图片",icon:"none"})},saveImageToAlbum(t){c({filePath:t,success:()=>{l(),s({title:"保存成功",icon:"success",duration:2e3})},fail:t=>{l(),console.error("保存到相册失败:",t),t.errMsg&&t.errMsg.includes("auth deny")?r({title:"权限提示",content:"需要相册权限才能保存图片，请在设置中开启权限",showCancel:!1,confirmText:"知道了"}):s({title:"保存失败",icon:"none",duration:2e3})}})},async convertImage(){let t="";if(this.isDrawMode){if(t=await this.getCanvasImage(),!t)return void s({title:"请先绘制图像",icon:"none"})}else{if(!this.inputImage)return void s({title:"请先选择图片",icon:"none"});t=this.inputImage}this.loading=!0,o({title:"AI处理中...",mask:!0});try{t.startsWith("blob:")?await this.uploadBlobImage(t):await this.uploadFileImage(t)}catch(e){console.error("转换错误:",e),s({title:e.message||"转换失败",icon:"none"})}finally{this.loading=!1,l()}},async uploadFileImage(t){const e=await new Promise(((e,s)=>{h({url:D,filePath:t,name:"image",success:e,fail:s})}));await this.handleServerResponse(e)},async uploadBlobImage(t){try{const e=await fetch(t),s=await e.blob(),a=new FormData;a.append("image",s,"image.jpg");const i=await fetch(D,{method:"POST",body:a});if(!i.ok)throw new Error(`上传失败: ${i.status}`);const n=await i.json();await this.handleOutputImage(n.image)}catch(e){throw console.error("Blob 上传错误:",e),e}},async handleServerResponse(t){if(200!==t.statusCode)throw new Error(`服务器错误: ${t.statusCode}`);{const e=JSON.parse(t.data);if("success"!==e.status||!e.image)throw new Error(e.error||"转换失败");await this.handleOutputImage(e.image),s({title:"转换完成"})}},async handleOutputImage(t){try{let e=t;e.startsWith("data:image/")||(e=`data:image/jpeg;base64,${t}`),this.outputImage=e,setTimeout((()=>{this.showOutputTip=!0}),1e3)}catch(e){console.error("处理输出图片错误:",e)}}}},[["render",function(t,e,s,a,i,n){const o=b,l=_,c=g,r=F,h=M,D=P;return f(),d(c,{class:"page-container"},{default:u((()=>[v(o,{class:"background",src:"/two/assets/bg_architecture-Cw0O17K8.png",mode:"aspectFill"}),v(c,{class:"title-bar"},{default:u((()=>[v(l,{class:"title-text"},{default:u((()=>[C("AI辅助立面设计")])),_:1})])),_:1}),v(c,{class:"main-content"},{default:u((()=>[v(c,{class:"left-section"},{default:u((()=>[v(c,{class:"glass-card input-card"},{default:u((()=>[v(c,{class:"card-header"},{default:u((()=>[v(l,{class:"card-title"},{default:u((()=>[C("输入图像")])),_:1})])),_:1}),i.isDrawMode?(f(),d(c,{key:1,class:"canvas-container"},{default:u((()=>[v(r,{"canvas-id":"drawingCanvas",id:"drawingCanvas",class:"drawing-canvas",onTouchstart:n.handleCanvasStart,onTouchmove:n.handleCanvasMove,onTouchend:n.handleCanvasEnd,onMousedown:n.handleCanvasStart,onMousemove:n.handleCanvasMove,onMouseup:n.handleCanvasEnd,onMouseleave:n.handleCanvasEnd,onDblclick:n.handleDoubleClick,onContextmenu:n.handleContextMenu,"disable-scroll":"true"},null,8,["onTouchstart","onTouchmove","onTouchend","onMousedown","onMousemove","onMouseup","onMouseleave","onDblclick","onContextmenu"])])),_:1})):(f(),d(c,{key:0,class:"image-upload",onClick:n.chooseImage},{default:u((()=>[i.inputImage?(f(),d(o,{key:0,src:i.inputImage,class:"image-preview",mode:"aspectFit"},null,8,["src"])):(f(),d(c,{key:1,class:"upload-placeholder"},{default:u((()=>[v(o,{src:"/two/assets/cloud-upload-CTmrf4YP.png",class:"icon"}),v(l,{class:"upload-text"},{default:u((()=>[C("点击上传建筑图像")])),_:1})])),_:1}))])),_:1},8,["onClick"]))])),_:1}),v(c,{class:"input-buttons"},{default:u((()=>[v(h,{class:p(["mode-btn",{active:!i.isDrawMode}]),onClick:e[0]||(e[0]=t=>n.setMode(!1))},{default:u((()=>[C("导入")])),_:1},8,["class"]),v(h,{class:p(["mode-btn",{active:i.isDrawMode}]),onClick:e[1]||(e[1]=t=>n.setMode(!0))},{default:u((()=>[C("绘制")])),_:1},8,["class"]),v(h,{class:"clear-btn",onClick:n.clearInput},{default:u((()=>[C("清空")])),_:1},8,["onClick"]),v(h,{class:"delete-btn",onClick:n.deleteSelectedRect,disabled:-1===i.selectedRectIndex},{default:u((()=>[C("删除")])),_:1},8,["onClick","disabled"])])),_:1}),i.isDrawMode?(f(),d(c,{key:0,class:"draw-tools"},{default:u((()=>[v(h,{class:"color-picker-btn",onClick:n.toggleColorPicker},{default:u((()=>[v(c,{class:"current-color-indicator",style:m({backgroundColor:i.currentColor})},null,8,["style"]),v(l,null,{default:u((()=>[C("取色")])),_:1})])),_:1},8,["onClick"]),v(h,{class:"tool-btn",onClick:n.undo},{default:u((()=>[C("撤销 (Ctrl+Z)")])),_:1},8,["onClick"]),v(h,{class:"tool-btn",onClick:n.clearCanvas},{default:u((()=>[C("清空画布")])),_:1},8,["onClick"]),v(h,{class:"tool-btn",onClick:n.toggleFillMode},{default:u((()=>[v(l,null,{default:u((()=>[C(w(i.fillMode?"填充模式":"描边模式"),1)])),_:1})])),_:1},8,["onClick"])])),_:1})):y("",!0)])),_:1}),v(c,{class:"convert-section"},{default:u((()=>[v(h,{class:"primary-btn",disabled:i.loading,onClick:n.convertImage},{default:u((()=>[i.loading?(f(),d(c,{key:0,class:"loader"})):(f(),d(l,{key:1},{default:u((()=>[C("转换")])),_:1}))])),_:1},8,["disabled","onClick"])])),_:1}),v(c,{class:"right-section"},{default:u((()=>[v(c,{class:"glass-card output-card"},{default:u((()=>[v(c,{class:"card-header"},{default:u((()=>[v(l,{class:"card-title"},{default:u((()=>[C("转换结果")])),_:1})])),_:1}),v(c,{class:"image-upload"},{default:u((()=>[i.outputImage?(f(),d(o,{key:0,src:i.outputImage,class:"image-preview output-image",mode:"aspectFit",onClick:n.previewOutputImage,onDblclick:n.previewOutputImage,onTouchstart:n.handleOutputTouchStart,onTouchend:n.handleOutputTouchEnd,onContextmenu:n.handleOutputContextMenu},null,8,["src","onClick","onDblclick","onTouchstart","onTouchend","onContextmenu"])):(f(),d(c,{key:1,class:"upload-placeholder"},{default:u((()=>[v(o,{src:"/two/assets/outline-building-afNQu6p-.png",class:"icon"}),v(l,{class:"upload-text"},{default:u((()=>[C("这里将展示AI生成的立面效果")])),_:1})])),_:1}))])),_:1})])),_:1}),v(c,{class:"output-buttons"},{default:u((()=>[v(h,{class:"clear-btn",onClick:n.clearOutput},{default:u((()=>[C("清空结果")])),_:1},8,["onClick"]),v(h,{class:"save-btn",onClick:n.saveOutputImage,disabled:!i.outputImage},{default:u((()=>[C("保存图片")])),_:1},8,["onClick","disabled"])])),_:1})])),_:1})])),_:1}),i.showColorPicker?(f(),d(c,{key:0,class:"color-picker-modal",onClick:e[4]||(e[4]=t=>i.showColorPicker=!1)},{default:u((()=>[v(c,{class:"color-picker-content",onClick:e[3]||(e[3]=k((()=>{}),["stop"]))},{default:u((()=>[v(c,{class:"color-picker-title"},{default:u((()=>[C("选择颜色")])),_:1}),v(c,{class:"color-palette"},{default:u((()=>[(f(!0),x(R,null,I(i.colorPalette,(t=>(f(),d(c,{key:t,class:"color-option",style:m({backgroundColor:t}),onClick:e=>n.selectColor(t)},null,8,["style","onClick"])))),128))])),_:1}),v(c,{class:"custom-color-area"},{default:u((()=>[v(l,{class:"custom-color-label"},{default:u((()=>[C("自定义颜色:")])),_:1}),v(c,{class:"color-input-row"},{default:u((()=>[v(D,{type:"text",modelValue:i.customColor,"onUpdate:modelValue":e[2]||(e[2]=t=>i.customColor=t),class:"color-input",placeholder:"#000000",onInput:n.validateColor},null,8,["modelValue","onInput"]),v(c,{class:"color-preview",style:m({backgroundColor:i.customColor})},null,8,["style"])])),_:1})])),_:1}),v(h,{class:"confirm-btn",onClick:n.confirmCustomColor},{default:u((()=>[C("确认")])),_:1},8,["onClick"])])),_:1})])),_:1})):y("",!0),i.showOutputTip?(f(),d(c,{key:1,class:"tip-modal",onClick:e[7]||(e[7]=t=>i.showOutputTip=!1)},{default:u((()=>[v(c,{class:"tip-content",onClick:e[6]||(e[6]=k((()=>{}),["stop"]))},{default:u((()=>[v(c,{class:"tip-title"},{default:u((()=>[C("操作提示")])),_:1}),v(c,{class:"tip-list"},{default:u((()=>[v(l,{class:"tip-item"},{default:u((()=>[C("• 单击或双击图片可放大预览")])),_:1}),v(l,{class:"tip-item"},{default:u((()=>[C("• 长按图片可保存到相册")])),_:1}),v(l,{class:"tip-item"},{default:u((()=>[C("• 右键点击图片可显示保存菜单")])),_:1}),v(l,{class:"tip-item"},{default:u((()=>[C('• 也可点击下方"保存图片"按钮')])),_:1})])),_:1}),v(h,{class:"confirm-btn",onClick:e[5]||(e[5]=t=>i.showOutputTip=!1)},{default:u((()=>[C("知道了")])),_:1})])),_:1})])),_:1})):y("",!0)])),_:1})}],["__scopeId","data-v-5dccdb46"]]);export{T as default};
